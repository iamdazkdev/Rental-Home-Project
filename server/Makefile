# Server Makefile - Rental Home Project
# Usage: make help - to see all available commands

.PHONY: help install clean dev start prepare-dev prepare-prod test test-concurrent test-scenarios logs

# Default target
help:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "           Server Makefile - Available Commands"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  Development:"
	@echo "    make install        - Install all dependencies"
	@echo "    make dev            - Start development server (nodemon)"
	@echo "    make start          - Start production server"
	@echo "    make clean          - Clean node_modules & logs"
	@echo "    make prepare-dev    - Prepare for development (clean + install)"
	@echo ""
	@echo "  Production:"
	@echo "    make prepare-prod   - Prepare for production (clean + install)"
	@echo ""
	@echo "  Testing:"
	@echo "    make test           - Run all tests"
	@echo "    make test-concurrent- Run concurrent booking tests"
	@echo "    make test-scenarios - Run booking scenario tests"
	@echo ""
	@echo "  Environment:"
	@echo "    make setup-env      - Setup .env file from example"
	@echo ""
	@echo "  Logs:"
	@echo "    make logs           - View server logs (tail)"
	@echo "    make logs-clear     - Clear server logs"
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""

# Install dependencies
install:
	@echo "ðŸ“¦ Installing server dependencies..."
	@npm install
	@echo "âœ… Server dependencies installed!"
	@echo ""
	@echo "Next: Run 'make setup-env' if needed, then 'make dev'"

# Clean node_modules and logs
clean:
	@echo "ðŸ§¹ Cleaning server files..."
	@rm -rf node_modules
	@rm -f server.log
	@rm -rf .cache
	@echo "âœ… Server cleaned!"

# Start development server with nodemon
dev:
	@echo "ðŸš€ Starting server in development mode..."
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "   Server will start on: http://localhost:3001"
	@echo "   Hot reload: Enabled (nodemon)"
	@echo "   Press Ctrl+C to stop"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@npm run dev 2>/dev/null || npm start

# Start production server
start:
	@echo "ðŸš€ Starting server in production mode..."
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "   Server running on: http://localhost:3001"
	@echo "   Mode: Production"
	@echo "   Press Ctrl+C to stop"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@npm start

# Prepare for development
prepare-dev: clean install setup-env
	@echo "âœ… Server ready for development!"
	@echo ""
	@echo "Run 'make dev' to start development server"

# Prepare for production
prepare-prod: clean install
	@echo "âœ… Server ready for production!"
	@echo ""
	@echo "Run 'make start' to start production server"

# Setup environment file
setup-env:
	@echo "âš™ï¸  Setting up environment file..."
	@if [ ! -f .env ]; then \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
			echo "âœ… Created .env from .env.example"; \
			echo "âš ï¸  Please update .env with your actual values"; \
		else \
			echo "âŒ .env.example not found"; \
		fi \
	else \
		echo "âœ… .env already exists"; \
	fi

# Run tests
test:
	@echo "ðŸ§ª Running server tests..."
	@npm test

# Run concurrent booking tests
test-concurrent:
	@echo "ðŸ§ª Running concurrent booking tests..."
	@npm run test:concurrent 2>/dev/null || echo "No concurrent test script found"

# Run booking scenario tests
test-scenarios:
	@echo "ðŸ§ª Running booking scenario tests..."
	@npm run test:scenarios:all 2>/dev/null || echo "No scenario test script found"

# View server logs
logs:
	@echo "ðŸ“‹ Server logs (press Ctrl+C to exit):"
	@echo ""
	@tail -f server.log 2>/dev/null || echo "No server.log found"

# Clear server logs
logs-clear:
	@echo "ðŸ§¹ Clearing server logs..."
	@rm -f server.log
	@echo "âœ… Logs cleared!"

# Database migration (if exists)
migrate:
	@echo "ðŸ—„ï¸  Running database migrations..."
	@npm run migrate 2>/dev/null || echo "No migration script found"

# Seed database (if exists)
seed:
	@echo "ðŸŒ± Seeding database..."
	@npm run seed 2>/dev/null || echo "No seed script found"

# Quick commands
.PHONY: i d s c
i: install
d: dev
s: start
c: clean

